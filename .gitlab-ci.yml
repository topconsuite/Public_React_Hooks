default:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
stages:
  - Build
  - Sonarqube analyze
  - NPM publish
variables:
  RULES_CHANGES_PATH: "**/*"

.base-rules:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - $RULES_CHANGES_PATH
    - when: manual
      allow_failure: true

Build:
  stage: Build
  extends: .base-rules
  needs: []
  script:
    - "npm install --global yarn"
    - "yarn"
Sonarqube analyze:
  stage: Sonarqube analyze
  extends: .base-rules
  needs: ["Build"]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar" # Defines the location of the analysis task cache
    GIT_DEPTH: "0" # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - ".sonar/cache"
  script:
    - "sonar-scanner"
  allow_failure: true
NPM publish:
  stage: NPM publish
  extends: .base-rules
  needs: ["Sonarqube analyze"]
  script:
    - yarn pubnpm
  allow_failure: true
